CREATE  TABLE GLOBAL_MARKETING.EFFICIENT_CUST_FLAGS_DATA_NOV20
AS

SELECT DISTINCT CUST.PARTY_ID,cust.data_date,T0_PORTFOY_SBU,STATU,SALARY,PORTFOLIO_CODE,
BRANCH_CODE,
BRANCH_NAME,
REGION_NAME,
PRESIDENTIAL_NAME,
PAYROLL_FLAG,
      NVL(ACTV_GPL_FLG,0) AS GPL_FLAG,
      NVL(ACTV_DEBIT_CARD_FLG,0) AS ACTV_DEBIT_CARD_FLG,
      NVL(ACTV_MORTGAGE_FLG,0) AS MORTGAGE_FLAG,
      NVL(ACTV_CAR_LOAN_FLG,0) AS CAR_FLAG,
      NVL(ACTV_OVERDRAFT_FLG,0) AS KMH_FLAG,
      NVL(ACTV_TIME_DEPOSIT_TL_FLG,0) AS TIME_DEPOSIT_TL,
      NVL(ACTV_TIME_DEPOSIT_FX_FLG,0) AS TIME_DEPOSIT_FX,
      NVL(ACTV_DEMAND_DEPOSIT_FX_FLG,0) AS DEMAND_DEPOSIT_FX,
      NVL(ACTV_STOCK_FLG,0) AS STOCK_FLAG,
      NVL(ACTV_BES_FLG,0) AS BES_FLAG,
      NVL(ACTV_LIFE_INSURANCE_FLG,0) AS LIFE_INS_FLAG,
      NVL(ACTV_CC_FLG,0) AS CC_FLAG,

      NVL(BILL_ACTV,0) AS BILL_ACTV,
      NVL(REGULER_PAYMENT,0) AS REGULER_PAYMENT,
      NVL(WORLD_MOBIL,0) AS WORLD_MOBIL,
      NVL(MOBIL_YK,0) AS MOBIL_YK,     
      NVL(PFA_FLAG200,0) AS PFA_FLAG200,
      NVL(TENURE_FLAG,0) AS TENURE_FLAG,    
      NVL(KASKO_TRAFIK_FLAG,0) AS KASKO_TRAFIK_FLAG,
      NVL(FERDI_YUVAM_FLAG,0) AS FERDI_YUVAM_FLAG,
      NVL(DIGER_ELEMENTER_FLAG,0) AS DIGER_ELEMENTER_FLAG,
      NVL(MORAL_NAZAR_FLG,0) AS MORAL_NAZAR_FLG,
      NVL(MOD_TMSS_FLAG,0) AS MOD_TMSS_FLAG,
      
BILL_SCORE_FLAG,COUNT_BILL



FROM
(
SELECT  DISTINCT party_id,data_date
,PORTFOY_SBU_V2 AS T0_PORTFOY_SBU
,STATU,
PORTFOLIO_CODE,
BRANCH_CODE,
BRANCH_NAME,
REGION_NAME,
PRESIDENTIAL_NAME

FROM
 (
SELECT DISTINCT party_id, data_date,STATU,
CASE WHEN final_pya_portfoy_sbu IS NOT NULL THEN final_pya_portfoy_sbu ELSE T0_PORTFOLIO_SBU_CODE END AS PORTFOY_SBU_V2,
CASE WHEN final_pya_portfoy_sbu IS NOT NULL THEN to_char(FINAL_PYA_PORTFOY_CODE) ELSE T0_PORTFOLIO_CODE END AS PORTFOLIO_CODE,
CASE WHEN final_pya_portfoy_sbu IS NOT NULL THEN FINAL_PYA_PORTFOY_BRANCH ELSE BRANCH_CODE END AS BRANCH_CODE,
CASE WHEN final_pya_portfoy_sbu IS NOT NULL THEN FINAL_PYA_BRANCH_NAME ELSE BRANCH_NAME END AS BRANCH_NAME,
CASE WHEN final_pya_portfoy_sbu IS NOT NULL THEN FINAL_PYA_REGION_NAME ELSE REGION_NAME END AS REGION_NAME,
CASE WHEN final_pya_portfoy_sbu IS NOT NULL THEN FINAL_PYA_PRESIDENTIAL_NAME ELSE PRESIDENTIAL_NAME END AS PRESIDENTIAL_NAME
FROM
(
SELECT DISTINCT PARTY_ID,data_date,concat('0',T0_PORTFOLIO_SBU_CODE) as T0_PORTFOLIO_SBU_CODE, 
CASE WHEN CURRENT_STATUS_ID=1 THEN 'AKTIF'
 WHEN CURRENT_STATUS_ID=2 THEN 'SKA'
 WHEN CURRENT_STATUS_ID=3 THEN 'DORMANT'
 WHEN CURRENT_STATUS_ID=4 THEN 'DORMANTPOOL'
 WHEN TRANSITION_STATUS_ID = 3 THEN 'YENI'
  WHEN CURRENT_STATUS_ID=5 THEN 'YENI' ELSE 'OTHER' END AS STATU,
    T0_PORTFOLIO_CODE,BRANCH_CODE, BRANCH_NAME, REGION_NAME, PRESIDENTIAL_NAME
FROM DM.CNF_CUSTOMER_HST A LEFT JOIN  DM.CNF_BRANCH B ON A.T0_PORTFOLIO_BRANCH_ID=B.BRANCH_ID
WHERE DATA_DATE=TO_DATE('20201130','YYYYMMDD')  AND CURRENT_STATUS_ID IN (1,2,5)
AND MVT_STATUS_ID=1 AND PARTY_ID NOT IN
              (
              ---WATCH2 CUST
              SELECT DISTINCT a.PARTY_ID
              FROM edw.PDM_CUSTOMER a
              LEFT JOIN edw.PDM_CUSTOMER_STAT_LKP b on a.PDM_CUSTOMER_STAT_ID = b.PDM_CUSTOMER_STAT_ID
              WHERE 
              DATA_DATE  = TO_DATE('20201130','YYYYMMDD')
              AND 
              TOT_PAST_DUE_AMOUNT_TL>0
              AND
              PAST_DUE_COUNT > 60 AND PAST_DUE_COUNT <= 180

              )
AND PARTY_ID NOT IN
(
--NPL CUST
SELECT DISTINCT a.PARTY_ID
FROM edw.PDM_CUSTOMER a
LEFT JOIN edw.PDM_CUSTOMER_STAT_LKP b on a.PDM_CUSTOMER_STAT_ID = b.PDM_CUSTOMER_STAT_ID
WHERE 
DATA_DATE  = TO_DATE('20201130','YYYYMMDD')
AND 
TOT_PAST_DUE_AMOUNT_TL>0 
AND
PAST_DUE_COUNT > 180
)
) A

LEFT JOIN
(
SELECT DISTINCT PYA_CLIENT_NO,final_pya_portfoy_sbu, FINAL_PYA_PORTFOY_CODE,FINAL_PYA_PORTFOY_BRANCH, BRANCH_NAME AS FINAL_PYA_BRANCH_NAME, 
REGION_NAME AS FINAL_PYA_REGION_NAME , PRESIDENTIAL_NAME AS FINAL_PYA_PRESIDENTIAL_NAME
FROM GLOBAL_DWH.CIF_PRTF_REL_27102020_pya_rev_2   A LEFT JOIN DM.CNF_BRANCH B ON TO_NUMBER(A.FINAL_PYA_PORTFOY_BRANCH)=B.BRANCH_CODE
WHERE final_pya_portfoy_sbu   IN ('0410', '0412', '0414', '0430', '0432')
) SEG
ON A.PARTY_ID=SEG.PYA_CLIENT_NO
) x
WHERE PORTFOY_SBU_V2 IN ('0410', '0412', '0414', '0430', '0432') 
)CUST

LEFT OUTER JOIN
(
SELECT DISTINCT Party_Id,1 as TENURE_FLAG
FROM
(
SELECT DISTINCT Party_Id, Count(Distinct Data_Date)
FROM dm.cnf_customer_hst
WHERE data_date in (TO_DATE('20200930','YYYYMMDD'),TO_DATE('20200831','YYYYMMDD'),
TO_DATE('20200731','YYYYMMDD'),TO_DATE('20200630','YYYYMMDD'),TO_DATE('20201031','YYYYMMDD'),TO_DATE('20201130','YYYYMMDD'))
AND current_status_id in (1,2) AND MVT_STATUS_ID=1
GROUP BY party_id 
HAVING COUNT(DISTINCT Data_Date) =6
))tn
on CUST.PARTY_ID=tn.party_id


LEFT OUTER JOIN 
(
Select DISTINCT A.EMPLOYEE_PARTY_ID AS PERSONEL_CIF, A.DATA_DATE,1 AS SALARY
--SUM(NVL(a.LAST_2_MONTHS_AVG_SAL_AMT_TL,0)) AS SALARY

FROM DM.MAR_SAL_PMNT_CUST_SUM_MONTHLY A, DM.MAR_COMPANY_PAYROLL_FLG_DAILY B
WHERE A.EMPLOYER_PARTY_ID=B.EMPLOYER_PARTY_ID AND A.DATA_DATE=B.DATA_DATE  AND A.DATA_DATE =TO_DATE('20201130','YYYYMMDD')
AND SALARY_PAYMENT_TYPE_ID=1 AND A.EMPLOYEE_PARTY_ID NOT IN (1780,
1788,
2261,
2682,
2683,
8594)
)M
on CUST.PARTY_ID=M.PERSONEL_CIF

LEFT OUTER JOIN 

(
Select DISTINCT A.EMPLOYEE_PARTY_ID,1 as PAYROLL_FLAG
FROM DM.MAR_SAL_PMNT_CUST_SUM_MONTHLY A
WHERE  A.DATA_DATE=TO_DATE('20201130','YYYYMMDD')  AND SALARY_PAYMENT_TYPE_ID in (2,3)
 
 )PAY
on CUST.PARTY_ID=PAY.EMPLOYEE_PARTY_ID

      LEFT OUTER JOIN

      (
      SELECT *
          FROM
          DM.CNF_CUSTOMER_APU_CS_DAILY
          WHERE
          DATA_DATE=TO_DATE('20201130','YYYYMMDD')
      )APU
      ON CUST.PARTY_ID=APU.PARTY_ID


LEFT OUTER JOIN
(----ACTV BILL PAYMENT&BİLLSCORE

SELECT DISTINCT A.ORDER_PARTY_ID,1 AS BILL_ACTV,
COUNT(distinct A.ORDER_ID) AS COUNT_BILL,
CASE 
WHEN COUNT(distinct A.ORDER_ID)=0 THEN '0'
WHEN COUNT(distinct A.ORDER_ID)=1 THEN '1' 
WHEN COUNT(distinct A.ORDER_ID)=2 THEN '1'
WHEN COUNT(distinct A.ORDER_ID)>=3 THEN '2'
ELSE 'OTHER' END AS BILL_SCORE_FLAG
FROM EDW.PCO_BILL_ORDER A
      LEFT JOIN EDW.PCO_ORDER_STAT_HST D ON A.ORDER_ID = D.ORDER_ID
      LEFT JOIN EDW.PCO_CORPORATION C ON A.CORPORATION_ID = C.CORPORATION_ID 
      LEFT JOIN EDW.PCO_BILL_TRANSACTION E ON A.ORDER_ID = E.ORDER_ID
WHERE C.SOURCE_SYS_PRODUCT_CODE IN ('SU','TAHSİLAT','TAHSILAT','ELEKTRİK','ELEKTRIK','DOĞALGAZ','DOGALGAZ','CEPTEL','TELEKOM')
AND A.ORDER_DATE <= TO_DATE('20201130','YYYYMMDD') AND START_DATE<=TO_DATE('20201130','YYYYMMDD') AND END_DATE>=TO_DATE('20201130','YYYYMMDD')
AND D.ORDER_STAT_ID = 1 AND E.TRANSACTION_DATE BETWEEN TO_DATE('20201001','YYYYMMDD')  AND TO_DATE('20201130','YYYYMMDD')
 AND E.AUTO_PAYMENT_FLG=1
GROUP BY
A.ORDER_PARTY_ID
)es
ON CUST.PARTY_ID=es.ORDER_PARTY_ID

LEFT OUTER JOIN

(
SELECT DISTINCT A.ORDER_PARTY_ID,1 AS REGULER_PAYMENT
FROM EDW.PCO_REGULAR_PAYMENT_ORDER A
      LEFT JOIN EDW.PCO_ORDER_STAT_HST D ON A.ORDER_ID = D.ORDER_ID
      LEFT JOIN EDW.PCO_REGULAR_TRANSACTION E ON A.ORDER_ID = E.ORDER_ID
WHERE  A.ORDER_DATE <= TO_DATE('20201130','YYYYMMDD') AND START_DATE<=TO_DATE('20201130','YYYYMMDD') AND END_DATE>=TO_DATE('20201130','YYYYMMDD')
AND D.ORDER_STAT_ID = 1 AND E.TRANSACTION_DATE BETWEEN TO_DATE('20201001','YYYYMMDD')  
AND TO_DATE('20201130','YYYYMMDD') AND E.AUTO_PAYMENT_FLG=1

)DZ
ON CUST.PARTY_ID=DZ.ORDER_PARTY_ID

LEFT OUTER JOIN
(
SELECT DISTINCT party_id,1 as PFA_FLAG200
FROM dm.cnf_bdg_customer_act_sum_daily a
WHERE 1=1
AND a.DATA_DATE=TO_DATE('20201130','YYYYMMDD') AND a.RELATION_TYPE_ID=1 AND a.KPI_ID=7499
)pf2
ON CUST.PARTY_ID=pf2.party_id
LEFT OUTER JOIN
(
select distinct PARTY_ID,1 AS WORLD_MOBIL
from DM.MAR_CUST_CHN_ACTV_FLG_MONTHLY
where data_date=TO_DATE('20201130','YYYYMMDD') and ACTIVE_YKB_WORLD_MOB_BANK_FLG=1
)MB
ON CUST.PARTY_ID=MB.PARTY_ID 
LEFT OUTER JOIN
(
SELECT DISTINCT A.PARTY_ID,
case when  (A.IDV_MBL_ACTV_FLG=1 or A.NUVO_MBL_ACTV_FLG=1 OR A.COMM_MBL_ACTV_FLG = 1) then 1 else 0 end as MOBIL_YK

FROM DM.CNF_CUST_CHN_ACTV_FLG_MONTHLY  A
WHERE  
 A.DATA_DATE = TO_DATE ('20201130','YYYYMMDD') 
)ykbw
on cust.PARTY_ID=ykbw.PARTY_ID 


LEFT OUTER JOIN
(---FUNDS
SELECT DISTINCT party_id ,
CASE WHEN  a.RELATION_TYPE_ID=1 and a.KPI_ID=7533 THEN 1 ELSE 0 END NITELIKLI_FLAG,
CASE WHEN  a.RELATION_TYPE_ID=1 AND a.KPI_ID=7534 THEN 1 ELSE 0 END  LIKIT_FLAG

FROM dm.cnf_bdg_customer_act_sum_daily a
WHERE 1=1
AND a.DATA_DATE=TO_DATE('20201130','YYYYMMDD')
)fn
on cust.PARTY_ID=fn.PARTY_ID

LEFT OUTER JOIN
(

--INSURANCE

SELECT DISTINCT party_id,1 as KASKO_TRAFIK_FLAG
FROM (
SELECT BASE.DATA_DATE,
       BASE.PARTY_ID,
      ACTV_PRODUCT_FLG
       
  FROM (SELECT TO_DATE('20201130','YYYYMMDD') DATA_DATE,
                PARTY_ID
          FROM EDW.PTY_CUSTOMER,
               EDW.PTY_CUSTOMER_MVT_STAT_LKP
         WHERE PTY_CUSTOMER.MVT_STAT_ID = PTY_CUSTOMER_MVT_STAT_LKP.MVT_STAT_ID
           AND PTY_CUSTOMER_MVT_STAT_LKP.MVT_STAT_CODE = 'A'
           AND TRUNC(PARTY_OPEN_DATE) <= TO_DATE('20201130','YYYYMMDD') --ETL_DATE
           AND NVL(PARTY_CLOSE_DATE,
                   TO_DATE('99991231',
                           'YYYYMMDD')) >= TO_DATE('20201130','YYYYMMDD') 
        ) BASE,
       ((SELECT DISTINCT TO_DATE('20201130','YYYYMMDD') DATA_DATE,
                        BNK_SRV_INSURANCE.PRIMARY_OWNER_PARTY_ID AS PARTY_ID,
                        20 AS PRODUCT_GROUP_ID,
                        1 AS ACTV_PRODUCT_FLG from EDW.BNK_SRV_STAT_HST,
EDW.BNK_SRV_DET_STAT_LKP,
EDW.BNK_SRV_INSURANCE,
 EDW.PRD_PRODUCT 
 WHERE BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_ID=BNK_SRV_STAT_HST.BANKING_SERVICE_DET_STAT_ID
  AND BNK_SRV_INSURANCE.BANKING_SERVICE_ID=BNK_SRV_STAT_HST.BANKING_SERVICE_ID
   AND PRD_PRODUCT.PRODUCT_ID =BNK_SRV_INSURANCE.PRODUCT_ID
    AND TO_DATE('20201130','YYYYMMDD') BETWEEN TRUNC(BNK_SRV_STAT_HST.START_DATE) AND NVL(BNK_SRV_STAT_HST.END_DATE,
                                                                                     TO_DATE('99991231',
                                                                                             'YYYYMMDD'))   
 AND BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_CODE IN ('P', --'Poliçeleşti',
                                                                      'M' -- 'Tenzil'
                                                                      )
                                                                       AND EDW.BNK_SRV_STAT_HST.BANKING_SERVICE_STAT_ID=1--STATU
    AND   PRD_PRODUCT.PRODUCT_NK IN(
                            'KASKO','TRAFIK')
                              and   PRD_PRODUCT.end_date>TO_DATE('20201130','YYYYMMDD') 
AND BNK_SRV_INSURANCE.BANKING_SERVICE_OPEN_DATE<=TO_DATE('20201130','YYYYMMDD')
AND (NVL(BNK_SRV_INSURANCE .BANKING_SERVICE_CLOSE_DATE ,TO_DATE('99991231','YYYYMMDD')))>=
TO_DATE('20201130','YYYYMMDD')

        )
UNION ALL
    (SELECT DISTINCT TO_DATE('20201130','YYYYMMDD') DATA_DATE,
                        BNK_SRV_X_PARTY.PARTY_ID AS PARTY_ID,
                        20 AS PRODUCT_GROUP_ID,
                        1 AS ACTV_PRODUCT_FLG from EDW.BNK_SRV_STAT_HST,
EDW.BNK_SRV_DET_STAT_LKP,
EDW.BNK_SRV_INSURANCE,
 EDW.PRD_PRODUCT ,
 EDW.BNK_SRV_X_PARTY 
 WHERE BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_ID=BNK_SRV_STAT_HST.BANKING_SERVICE_DET_STAT_ID
 AND BNK_SRV_INSURANCE.BANKING_SERVICE_ID=BNK_SRV_STAT_HST.BANKING_SERVICE_ID
 AND PRD_PRODUCT.PRODUCT_ID =BNK_SRV_INSURANCE.PRODUCT_ID
 AND TO_DATE('20201130','YYYYMMDD') BETWEEN TRUNC(BNK_SRV_STAT_HST.START_DATE) AND NVL(BNK_SRV_STAT_HST.END_DATE,
                                                                                     TO_DATE('99991231',
        
                                                                                         'YYYYMMDD'))   
  AND EDW.BNK_SRV_STAT_HST.BANKING_SERVICE_STAT_ID=1
 AND BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_CODE IN ('P', --'Poliçeleşti',
                                                                      'M' -- 'Tenzil'
                                                                      )
    AND   PRD_PRODUCT.PRODUCT_NK IN(
                            'KASKO','TRAFIK')
                              AND   PRD_PRODUCT.end_date>TO_DATE('20201130','YYYYMMDD')
                  AND BNK_SRV_INSURANCE.BANKING_SERVICE_ID=BNK_SRV_X_PARTY.BANKING_SERVICE_ID
                AND BNK_SRV_X_PARTY.PRIMARY_OWNER_FLG=0
                 AND BNK_SRV_X_PARTY.end_date>TO_DATE('20201130','YYYYMMDD')
AND BNK_SRV_INSURANCE.BANKING_SERVICE_OPEN_DATE<=TO_DATE('20201130','YYYYMMDD')
AND (NVL(BNK_SRV_INSURANCE .BANKING_SERVICE_CLOSE_DATE ,TO_DATE('99991231','YYYYMMDD')))>=
TO_DATE('20201130','YYYYMMDD')

        )
        ) AKTIFLIK WHERE
    BASE.PARTY_ID = AKTIFLIK.PARTY_ID(+)
   AND BASE.DATA_DATE = AKTIFLIK.DATA_DATE(+)
   AND ACTV_PRODUCT_FLG = 1)
   )kask
   on cust.PARTY_ID=kask.PARTY_ID
   
LEFT OUTER JOIN
(
SELECT DISTINCT party_id,1 AS FERDI_YUVAM_FLAG
 FROM (
SELECT BASE.DATA_DATE,
       BASE.PARTY_ID,
      ACTV_PRODUCT_FLG
       
  FROM (SELECT TO_DATE('20201130','YYYYMMDD') DATA_DATE,
                PARTY_ID
          FROM EDW.PTY_CUSTOMER,
               EDW.PTY_CUSTOMER_MVT_STAT_LKP
         WHERE PTY_CUSTOMER.MVT_STAT_ID = PTY_CUSTOMER_MVT_STAT_LKP.MVT_STAT_ID
           AND PTY_CUSTOMER_MVT_STAT_LKP.MVT_STAT_CODE = 'A'
           AND TRUNC(PARTY_OPEN_DATE) <= TO_DATE('20201130','YYYYMMDD') --ETL_DATE
           AND NVL(PARTY_CLOSE_DATE,
                   TO_DATE('99991231',
                           'YYYYMMDD')) >= TO_DATE('20201130','YYYYMMDD')
        ) BASE,
       ((SELECT DISTINCT TO_DATE('20201130','YYYYMMDD') DATA_DATE,
                        BNK_SRV_INSURANCE.PRIMARY_OWNER_PARTY_ID AS PARTY_ID,
                        20 AS PRODUCT_GROUP_ID,
                        1 AS ACTV_PRODUCT_FLG from EDW.BNK_SRV_STAT_HST,
EDW.BNK_SRV_DET_STAT_LKP,
EDW.BNK_SRV_INSURANCE,
 EDW.PRD_PRODUCT 
 WHERE BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_ID=BNK_SRV_STAT_HST.BANKING_SERVICE_DET_STAT_ID
  AND BNK_SRV_INSURANCE.BANKING_SERVICE_ID=BNK_SRV_STAT_HST.BANKING_SERVICE_ID
   AND PRD_PRODUCT.PRODUCT_ID =BNK_SRV_INSURANCE.PRODUCT_ID
   AND TO_DATE('20201130','YYYYMMDD') BETWEEN TRUNC(BNK_SRV_STAT_HST.START_DATE) AND NVL(BNK_SRV_STAT_HST.END_DATE,
                                                                                     TO_DATE('99991231',
                                                                                             'YYYYMMDD'))   
 AND BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_CODE IN ('P', --'Poliçeleşti',
                                                                      'M' -- 'Tenzil'
                                                                      )
                                                                       AND EDW.BNK_SRV_STAT_HST.BANKING_SERVICE_STAT_ID=1
    AND   PRD_PRODUCT.PRODUCT_NK IN(
                            'YUVAMPKT',
                           'FERDKAZA'
)  
                              AND   PRD_PRODUCT.end_date>TO_DATE('20201130','YYYYMMDD') 
AND BNK_SRV_INSURANCE.BANKING_SERVICE_OPEN_DATE<=TO_DATE('20201130','YYYYMMDD')
AND (NVL(BNK_SRV_INSURANCE .BANKING_SERVICE_CLOSE_DATE ,TO_DATE('99991231','YYYYMMDD')))>=
TO_DATE('20201130','YYYYMMDD')

        )
UNION ALL
    (SELECT DISTINCT TO_DATE('20201130','YYYYMMDD') DATA_DATE,
                        BNK_SRV_X_PARTY.PARTY_ID AS PARTY_ID,
                        20 AS PRODUCT_GROUP_ID,
                        1 AS ACTV_PRODUCT_FLG from EDW.BNK_SRV_STAT_HST,
EDW.BNK_SRV_DET_STAT_LKP,
EDW.BNK_SRV_INSURANCE,
 EDW.PRD_PRODUCT ,
 EDW.BNK_SRV_X_PARTY 
 WHERE BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_ID=BNK_SRV_STAT_HST.BANKING_SERVICE_DET_STAT_ID
  AND BNK_SRV_INSURANCE.BANKING_SERVICE_ID=BNK_SRV_STAT_HST.BANKING_SERVICE_ID
   AND PRD_PRODUCT.PRODUCT_ID =BNK_SRV_INSURANCE.PRODUCT_ID
    AND TO_DATE('20201130','YYYYMMDD') BETWEEN TRUNC(BNK_SRV_STAT_HST.START_DATE) AND NVL(BNK_SRV_STAT_HST.END_DATE,
                                                                                     TO_DATE('99991231',
        
                                                                                         'YYYYMMDD'))   
  AND EDW.BNK_SRV_STAT_HST.BANKING_SERVICE_STAT_ID=1
 AND BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_CODE IN ('P', --'Poliçeleşti',
                                                                      'M' -- 'Tenzil'
                                                                      )
    AND   PRD_PRODUCT.PRODUCT_NK IN(
                            'YUVAMPKT',
                           'FERDKAZA'
) 
                              AND   PRD_PRODUCT.end_date>TO_DATE('20201130','YYYYMMDD')
                  AND BNK_SRV_INSURANCE.BANKING_SERVICE_ID=BNK_SRV_X_PARTY.BANKING_SERVICE_ID
                AND BNK_SRV_X_PARTY.PRIMARY_OWNER_FLG=0
                 AND BNK_SRV_X_PARTY.end_date>TO_DATE('20201130','YYYYMMDD')
AND BNK_SRV_INSURANCE.BANKING_SERVICE_OPEN_DATE<=TO_DATE('20201130','YYYYMMDD')
AND (NVL(BNK_SRV_INSURANCE .BANKING_SERVICE_CLOSE_DATE ,TO_DATE('99991231','YYYYMMDD')))>=
TO_DATE('20201130','YYYYMMDD')

        )
        ) AKTIFLIK WHERE
    BASE.PARTY_ID = AKTIFLIK.PARTY_ID(+)
   AND BASE.DATA_DATE = AKTIFLIK.DATA_DATE(+)
   AND ACTV_PRODUCT_FLG = 1)
   )FRYV
      ON cust.PARTY_ID=FRYV.PARTY_ID
LEFT OUTER JOIN
(

SELECT DISTINCT party_id,1 AS DIGER_ELEMENTER_FLAG

 FROM (
SELECT BASE.DATA_DATE,
       BASE.PARTY_ID,
      ACTV_PRODUCT_FLG
       
  FROM (SELECT TO_DATE('20201130','YYYYMMDD') DATA_DATE,
                PARTY_ID
          FROM EDW.PTY_CUSTOMER,
               EDW.PTY_CUSTOMER_MVT_STAT_LKP
         WHERE PTY_CUSTOMER.MVT_STAT_ID = PTY_CUSTOMER_MVT_STAT_LKP.MVT_STAT_ID
           AND PTY_CUSTOMER_MVT_STAT_LKP.MVT_STAT_CODE = 'A'
           AND TRUNC(PARTY_OPEN_DATE) <= TO_DATE('20201130','YYYYMMDD') --ETL_DATE
           AND NVL(PARTY_CLOSE_DATE,
                   TO_DATE('99991231',
                           'YYYYMMDD')) >= TO_DATE('20201130','YYYYMMDD') 
        ) BASE,
       ((SELECT DISTINCT TO_DATE('20201130','YYYYMMDD') DATA_DATE,
                        BNK_SRV_INSURANCE.PRIMARY_OWNER_PARTY_ID AS PARTY_ID,
                        20 AS PRODUCT_GROUP_ID,
                        1 AS ACTV_PRODUCT_FLG from EDW.BNK_SRV_STAT_HST,
EDW.BNK_SRV_DET_STAT_LKP,
EDW.BNK_SRV_INSURANCE,
 EDW.PRD_PRODUCT 
 WHERE BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_ID=BNK_SRV_STAT_HST.BANKING_SERVICE_DET_STAT_ID
  AND BNK_SRV_INSURANCE.BANKING_SERVICE_ID=BNK_SRV_STAT_HST.BANKING_SERVICE_ID
   AND PRD_PRODUCT.PRODUCT_ID =BNK_SRV_INSURANCE.PRODUCT_ID
    AND TO_DATE('20201130','YYYYMMDD') BETWEEN TRUNC(BNK_SRV_STAT_HST.START_DATE) AND NVL(BNK_SRV_STAT_HST.END_DATE,
                                                                                     TO_DATE('99991231',
                                                                                             'YYYYMMDD'))   
 AND BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_CODE IN ('P', --'Poliçeleşti',
                                                                      'M' -- 'Tenzil'
                                                                      )
                                                                       AND EDW.BNK_SRV_STAT_HST.BANKING_SERVICE_STAT_ID=1
    AND   PRD_PRODUCT.PRODUCT_NK IN('ELMSIGURN',
                            'DEPRMDASK',
                           -- 'YUVAMPKT',
                            --'KASKO',
                           -- 'MORALALT',
                           -- 'NAZARALT',
                           --'FERDKAZA',
                             'ESYAMSIG',
                             'KGUVEN'
                             --'TRAFIK'
                             )                             AND   PRD_PRODUCT.end_date>TO_DATE('20201130','YYYYMMDD') 
AND BNK_SRV_INSURANCE.BANKING_SERVICE_OPEN_DATE<=TO_DATE('20201130','YYYYMMDD')
AND (NVL(BNK_SRV_INSURANCE .BANKING_SERVICE_CLOSE_DATE ,TO_DATE('99991231','YYYYMMDD')))>=
TO_DATE('20201130','YYYYMMDD')

        )
UNION ALL 
    (SELECT DISTINCT TO_DATE('20201130','YYYYMMDD') DATA_DATE,
                        BNK_SRV_X_PARTY.PARTY_ID AS PARTY_ID,
                        20 AS PRODUCT_GROUP_ID,
                        1 AS ACTV_PRODUCT_FLG from EDW.BNK_SRV_STAT_HST,
EDW.BNK_SRV_DET_STAT_LKP,
EDW.BNK_SRV_INSURANCE,
 EDW.PRD_PRODUCT ,
 EDW.BNK_SRV_X_PARTY 
 WHERE BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_ID=BNK_SRV_STAT_HST.BANKING_SERVICE_DET_STAT_ID
  AND BNK_SRV_INSURANCE.BANKING_SERVICE_ID=BNK_SRV_STAT_HST.BANKING_SERVICE_ID
   AND PRD_PRODUCT.PRODUCT_ID =BNK_SRV_INSURANCE.PRODUCT_ID
    AND TO_DATE('20201130','YYYYMMDD') BETWEEN TRUNC(BNK_SRV_STAT_HST.START_DATE) AND NVL(BNK_SRV_STAT_HST.END_DATE,
                                                                                     TO_DATE('99991231',
        
                                                                                         'YYYYMMDD'))  
  AND EDW.BNK_SRV_STAT_HST.BANKING_SERVICE_STAT_ID=1
 AND BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_CODE IN ('P', --'Poliçeleşti',
                                                                      'M' -- 'Tenzil'
                                                                      )
    AND   PRD_PRODUCT.PRODUCT_NK IN('ELMSIGURN',
                            'DEPRMDASK',
                           -- 'YUVAMPKT',
                            --'KASKO',
                           -- 'MORALALT',
                           -- 'NAZARALT',
                           --'FERDKAZA',
                             'ESYAMSIG',
                             'KGUVEN'
                             --'TRAFIK'
                             )   
                              AND   PRD_PRODUCT.end_date>TO_DATE('20201130','YYYYMMDD')
                  AND BNK_SRV_INSURANCE.BANKING_SERVICE_ID=BNK_SRV_X_PARTY.BANKING_SERVICE_ID
                AND BNK_SRV_X_PARTY.PRIMARY_OWNER_FLG=0
                 AND BNK_SRV_X_PARTY.end_date>TO_DATE('20201130','YYYYMMDD')
AND BNK_SRV_INSURANCE.BANKING_SERVICE_OPEN_DATE<=TO_DATE('20201130','YYYYMMDD')
AND (NVL(BNK_SRV_INSURANCE .BANKING_SERVICE_CLOSE_DATE ,TO_DATE('99991231','YYYYMMDD')))>=
TO_DATE('20201130','YYYYMMDD')

        )
        ) AKTIFLIK WHERE
    BASE.PARTY_ID = AKTIFLIK.PARTY_ID(+)
   AND BASE.DATA_DATE = AKTIFLIK.DATA_DATE(+)
   AND ACTV_PRODUCT_FLG = 1)
   )DELM
         ON cust.PARTY_ID=DELM.PARTY_ID
LEFT OUTER JOIN
(

SELECT DISTINCT party_id,1 AS MORAL_NAZAR_FLG
FROM(
SELECT BASE.DATA_DATE,
       BASE.PARTY_ID,
      ACTV_PRODUCT_FLG
  FROM (SELECT TO_DATE('20201130','YYYYMMDD')  DATA_DATE,
               PARTY_ID
          FROM EDW.PTY_CUSTOMER,
               EDW.PTY_CUSTOMER_MVT_STAT_LKP
         WHERE PTY_CUSTOMER.MVT_STAT_ID = PTY_CUSTOMER_MVT_STAT_LKP.MVT_STAT_ID
           AND PTY_CUSTOMER_MVT_STAT_LKP.MVT_STAT_CODE = 'A'
           AND TRUNC(PARTY_OPEN_DATE) <=TO_DATE('20201130','YYYYMMDD')  --ETL_DATE
           AND NVL(PARTY_CLOSE_DATE,
                   TO_DATE('99991231',
                           'YYYYMMDD')) >= TO_DATE('20201130','YYYYMMDD') 
        ) BASE,
        
        
       ((SELECT DISTINCT TO_DATE('20201130','YYYYMMDD')  DATA_DATE,
                        BNK_SRV_INSURANCE.PRIMARY_OWNER_PARTY_ID AS PARTY_ID,
                        50 AS PRODUCT_GROUP_ID,
                        1 AS ACTV_PRODUCT_FLG
          FROM EDW.BNK_SRV_INSURANCE,
               EDW.BNK_SRV_STAT_HST,
               EDW.PRD_PRODUCT,
               EDW.BNK_SRV_DET_STAT_LKP
        
         WHERE BNK_SRV_INSURANCE.BANKING_SERVICE_ID = BNK_SRV_STAT_HST.BANKING_SERVICE_ID
              
           AND TO_DATE('20201130','YYYYMMDD') BETWEEN TRUNC(BNK_SRV_STAT_HST.START_DATE) AND NVL(BNK_SRV_STAT_HST.END_DATE,
                                                                                     TO_DATE('99991231',
                                                                                             'YYYYMMDD'))  
           AND BNK_SRV_STAT_HST.BANKING_SERVICE_DET_STAT_ID = BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_ID
           AND BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_CODE IN ('P', --'Poliçeleşti',
                                                                      'M' -- 'Tenzil'
                                                                      )
                                                                       AND EDW.BNK_SRV_STAT_HST.BANKING_SERVICE_STAT_ID=1
           AND BNK_SRV_INSURANCE.PRODUCT_ID = PRD_PRODUCT.PRODUCT_ID
           AND PRODUCT_NK  IN (
                           'MORALALT',
                           'NAZARALT'
) 
          AND BNK_SRV_INSURANCE.BANKING_SERVICE_OPEN_DATE<=TO_DATE('20201130','YYYYMMDD')
        )
    UNION ALL
    (SELECT DISTINCT TO_DATE('20201130','YYYYMMDD')  DATA_DATE,
                       BNK_SRV_X_PARTY .PARTY_ID AS PARTY_ID,
                        50 AS PRODUCT_GROUP_ID,
                        1 AS ACTV_PRODUCT_FLG
          FROM EDW.BNK_SRV_INSURANCE,
               EDW.BNK_SRV_STAT_HST,
               EDW.PRD_PRODUCT,
               EDW.BNK_SRV_DET_STAT_LKP, 
         EDW.BNK_SRV_X_PARTY 
        
         WHERE BNK_SRV_INSURANCE.BANKING_SERVICE_ID = BNK_SRV_STAT_HST.BANKING_SERVICE_ID
              
           AND TO_DATE('20201130','YYYYMMDD') BETWEEN TRUNC(BNK_SRV_STAT_HST.START_DATE) AND NVL(BNK_SRV_STAT_HST.END_DATE,
                                                                                     TO_DATE('99991231',
                                                                                             'YYYYMMDD'))   
           AND BNK_SRV_STAT_HST.BANKING_SERVICE_DET_STAT_ID = BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_ID
           AND BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_CODE IN ('P', --'Poliçeleşti',
                                                                      'M' -- 'Tenzil'
                                                                      )
                                                                       AND EDW.BNK_SRV_STAT_HST.BANKING_SERVICE_STAT_ID=1
           AND BNK_SRV_INSURANCE.PRODUCT_ID = PRD_PRODUCT.PRODUCT_ID
           AND PRODUCT_NK IN (
                           'MORALALT',
                           'NAZARALT'
)
                AND BNK_SRV_INSURANCE.BANKING_SERVICE_ID=BNK_SRV_X_PARTY.BANKING_SERVICE_ID
                AND BNK_SRV_X_PARTY.PRIMARY_OWNER_FLG=0
                 AND BNK_SRV_X_PARTY.end_date>TO_DATE('20201130','YYYYMMDD')
                 AND BNK_SRV_INSURANCE.BANKING_SERVICE_OPEN_DATE<=TO_DATE('20201130','YYYYMMDD')
        ))
        
        
    AKTIFLIK WHERE BASE.PARTY_ID = AKTIFLIK.PARTY_ID(+)
   AND BASE.DATA_DATE = AKTIFLIK.DATA_DATE(+)
   AND ACTV_PRODUCT_FLG=1)
)MN
ON cust.PARTY_ID=MN.PARTY_ID
LEFT OUTER JOIN 
(

SELECT DISTINCT party_id,1 as MOD_TMSS_FLAG
 

FROM(
SELECT BASE.DATA_DATE,
       BASE.PARTY_ID,
      ACTV_PRODUCT_FLG 
  FROM (SELECT TO_DATE('20201130','YYYYMMDD')  DATA_DATE,
               PARTY_ID
          FROM EDW.PTY_CUSTOMER,
               EDW.PTY_CUSTOMER_MVT_STAT_LKP
         WHERE PTY_CUSTOMER.MVT_STAT_ID = PTY_CUSTOMER_MVT_STAT_LKP.MVT_STAT_ID
           AND PTY_CUSTOMER_MVT_STAT_LKP.MVT_STAT_CODE = 'A'
           AND TRUNC(PARTY_OPEN_DATE) <=TO_DATE('20201130','YYYYMMDD')  --ETL_DATE
           AND NVL(PARTY_CLOSE_DATE,
                   TO_DATE('99991231',
                           'YYYYMMDD')) >= TO_DATE('20201130','YYYYMMDD')
       )
         BASE,

       ((SELECT DISTINCT TO_DATE('20201130','YYYYMMDD')  DATA_DATE,
                        BNK_SRV_INSURANCE.PRIMARY_OWNER_PARTY_ID AS PARTY_ID,
                        50 AS PRODUCT_GROUP_ID,
                        1 AS ACTV_PRODUCT_FLG
          FROM EDW.BNK_SRV_INSURANCE,
               EDW.BNK_SRV_STAT_HST,
               EDW.PRD_PRODUCT,
               EDW.BNK_SRV_DET_STAT_LKP
        
         WHERE BNK_SRV_INSURANCE.BANKING_SERVICE_ID = BNK_SRV_STAT_HST.BANKING_SERVICE_ID
              
           AND TO_DATE('20201130','YYYYMMDD') BETWEEN TRUNC(BNK_SRV_STAT_HST.START_DATE) AND NVL(BNK_SRV_STAT_HST.END_DATE,
                                                                                     TO_DATE('99991231',
                                                                                             'YYYYMMDD'))  
           AND BNK_SRV_STAT_HST.BANKING_SERVICE_DET_STAT_ID = BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_ID
           AND BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_CODE IN ('P', --'Poliçeleşti',
                                                                      'M' -- 'Tenzil'
                                                                      )
                                                                       AND EDW.BNK_SRV_STAT_HST.BANKING_SERVICE_STAT_ID=1
           AND BNK_SRV_INSURANCE.PRODUCT_ID = PRD_PRODUCT.PRODUCT_ID
           AND PRODUCT_NK IN (
                              'MODSAGSIG',
                              'BRYTMSS',
                              'GRPTMSS',
                              'KURUMSAGSIG',
                              'SAGLKSIGURN') 
          AND BNK_SRV_INSURANCE.BANKING_SERVICE_OPEN_DATE<=TO_DATE('20201130','YYYYMMDD')
      AND BNK_SRV_INSURANCE.BANKING_SERVICE_CLOSE_DATE>=TO_DATE('20201130','YYYYMMDD')
                      AND INSURANCE_DET_TP_ID  in
(

137722,
138641

)
        )
    UNION ALL
    (SELECT DISTINCT TO_DATE('20201130','YYYYMMDD')  DATA_DATE,
                       BNK_SRV_X_PARTY .PARTY_ID AS PARTY_ID,
                        50 AS PRODUCT_GROUP_ID,
                        1 AS ACTV_PRODUCT_FLG
          FROM EDW.BNK_SRV_INSURANCE,
               EDW.BNK_SRV_STAT_HST,
               EDW.PRD_PRODUCT,
               EDW.BNK_SRV_DET_STAT_LKP, 
         EDW.BNK_SRV_X_PARTY 
        
         WHERE BNK_SRV_INSURANCE.BANKING_SERVICE_ID = BNK_SRV_STAT_HST.BANKING_SERVICE_ID
              
           AND TO_DATE('20201130','YYYYMMDD') BETWEEN TRUNC(BNK_SRV_STAT_HST.START_DATE) AND NVL(BNK_SRV_STAT_HST.END_DATE,
                                                                                     TO_DATE('99991231',
                                                                                             'YYYYMMDD')) 
           AND BNK_SRV_STAT_HST.BANKING_SERVICE_DET_STAT_ID = BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_ID
           AND BNK_SRV_DET_STAT_LKP.BANKING_SERVICE_DET_STAT_CODE IN ('P', --'Poliçeleşti',
                                                                      'M' -- 'Tenzil'
                                                                      )
                                                                       AND EDW.BNK_SRV_STAT_HST.BANKING_SERVICE_STAT_ID=1
           AND BNK_SRV_INSURANCE.PRODUCT_ID = PRD_PRODUCT.PRODUCT_ID
           AND PRODUCT_NK IN (
                              'MODSAGSIG',
                              'BRYTMSS',
                              'GRPTMSS',
                              'KURUMSAGSIG',
                              'SAGLKSIGURN') 
                AND BNK_SRV_INSURANCE.BANKING_SERVICE_ID=BNK_SRV_X_PARTY.BANKING_SERVICE_ID
                AND BNK_SRV_X_PARTY.PRIMARY_OWNER_FLG=0
                 AND BNK_SRV_X_PARTY.END_DATE>=TO_DATE('20201130','YYYYMMDD')
                 AND BNK_SRV_X_PARTY.START_DATE<=TO_DATE('20201130','YYYYMMDD')
          AND BNK_SRV_INSURANCE.BANKING_SERVICE_OPEN_DATE<=TO_DATE('20201130','YYYYMMDD')
          AND BNK_SRV_INSURANCE.BANKING_SERVICE_CLOSE_DATE>=TO_DATE('20201130','YYYYMMDD')
                          AND INSURANCE_DET_TP_ID  in
(

137722,
138641

)
        ))
        
    AKTIFLIK WHERE BASE.PARTY_ID = AKTIFLIK.PARTY_ID(+)
    AND BASE.DATA_DATE = AKTIFLIK.DATA_DATE(+)
   ) WHERE ACTV_PRODUCT_FLG=1

)MDTS
ON cust.PARTY_ID=MDTS.PARTY_ID
